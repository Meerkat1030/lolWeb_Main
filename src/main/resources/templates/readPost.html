<!-- readPost.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Read Post</title>
    <!-- jQuery CDN을 사용하고 있다고 가정 -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>
<body>

<!-- 게시글 정보 표시 -->
<h2 th:text="${post.title}"></h2>
<p th:text="${post.content}"></p>
<div>
    <h3>Author Information:</h3>
    <p>작성자: <span th:text="${post.nickname}"></span></p>
    <p>IP Address: <span th:text="${post.ipAddress}"></span></p>
</div>
<button type="button" id="goToListButton">목록으로</button>
<!-- 댓글 목록 표시 -->
<h3>댓글 목록</h3>
<div th:if="${comment}">
    <ul>
        <li th:each="comment, commentIndex : ${comment}">
            <!-- 순차적인 번호를 출력 -->
            <span th:text="${commentIndex.index + 1}"></span>.
            <span th:text="${comment.nickname}"></span>
            <span th:text="${comment.ipAddress}"></span>
            <span th:text="${comment.content}"></span>
            <span th:text="${comment.createTime}"></span>
            <!-- 아이디 값을 직접 전달 -->
            <button type="button" class="likeButton" data-comment-id="${comment.id}" th:attr="data-comment-id=${comment.id}">좋아요</button>
            <span class="likeCount" data-comment-id="${comment.id}" th:attr="data-like-count=${comment.likes.size()}, data-comment-id=${comment.id}">
                좋아요 수: <span class="likeCountValue"></span>
            </span>
        </li>
    </ul>
</div>

<!-- 댓글 작성 폼 -->
<form id="commentForm">
    <input type="hidden" th:name="postId" id="postId" th:value="${post.id}">
    <label for="nickname">닉네임:</label>
    <input type="text" id="nickname" name="nickname" required>
    <br>
    <label for="password">비밀번호:</label>
    <input type="password" id="password" name="password" required>
    <br>
    <label for="content">댓글 내용:</label>
    <textarea id="content" name="content" required></textarea>
    <br>
    <button type="button" id="commentButton">댓글 작성</button>
</form>

<!-- JavaScript 코드 -->
<script th:inline="javascript">
    /*<![CDATA[*/
    var commentData = /*[[${comments}]]*/ [];
    /*]]>*/
</script>

<script>
    // 좋아요 수 갱신 함수
    function updateLikeCount(commentId) {
        console.log(commentId);
        $.ajax({
            type: "GET",
            url: "/" + commentId + "/like/count",
            success: function(response) {
                console.log("RES::: ",response);
                var likeCountValueElement = $(".likeCount[data-comment-id='" + commentId + "']");
                console.log(likeCountValueElement);

                // response가 0보다 크면 좋아요 수를 업데이트
                if (response > 0) {
                    console.log("좋아요가 존재합니다.");
                    likeCountValueElement.text("좋아요 수 :: ("+response+")");
                } else {
                    // 좋아요가 하나도 없으면 0으로 표시
                    console.log("좋아요가 존재하지 않슴둥.");
                    likeCountValueElement.text("좋아요 수 :: (0)");
                }

                // 좋아요 버튼 상태에 따라 색상 변경
                var likeButton = $(".likeButton[data-comment-id='" + commentId + "']");
                var isLiked = response > 0;
                likeButton.css("color", isLiked ? "blue" : "black");
            },
            error: function(error) {
                console.log(error);
                alert("좋아요 수 갱신 중 오류가 발생했습니다.");
            }
        });
    }

    // 초기에 모든 댓글에 대해 좋아요 수를 업데이트
    function updateAllCommentsLikeStatus() {
        $(".likeButton").each(function () {
            var likeButton = $(this);
            var commentId = likeButton.attr("data-comment-id");
            updateLikeCount(commentId);
        });
    }
    // 좋아요 버튼 클릭 시 동작
    $(document).on("click", ".likeButton", function() {
        var likeButton = $(this);
        // 타임리프로부터 직접 값을 받아옴
        var commentId = likeButton.attr("data-comment-id");

        $.ajax({
            type: "POST",
            url: "/" + commentId + "/like",
            contentType: "application/json",
            data: JSON.stringify({
                ipAddress: "dummy"
            }),
            success: function(response) {
                if (response === true) {
                    likeButton.css("color", "blue");
                } else {
                    likeButton.css("color", "black");
                }

                updateLikeCount(commentId);
            },
            error: function(error) {
                console.log(this.url);
                alert("좋아요 처리 중 오류가 발생했습니다.");
            }
        });
    });

    // 댓글 작성 버튼 클릭 시 동작
    function createComment() {
        $.ajax({
            type: "POST",
            url: "/post/createComment",
            contentType: "application/json",
            data: JSON.stringify({
                postId: $("#postId").val(),
                nickname: $("#nickname").val(),
                password: $("#password").val(),
                content: $("#content").val()
            }),
            success: function(response) {
                alert("댓글이 성공적으로 저장되었습니다.");
                location.reload();
                updateAllCommentsLikeStatus();
            },
            error: function(error) {
                alert("댓글 작성에 실패했습니다.");
            }
        });
    }

    $(document).ready(function () {
        // 초기에 모든 댓글에 대해 좋아요 수를 업데이트
        updateAllCommentsLikeStatus();

        // 나머지 코드는 그대로 유지
        $("#commentButton").click(createComment);

        // "목록으로" 버튼 클릭 시 post/list 페이지로 이동
        $("#goToListButton").click(function() {
            window.location.href = "/post/list";
        });
    });
</script>

</body>
</html>
